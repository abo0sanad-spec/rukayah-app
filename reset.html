<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>إعادة تفعيل رمز الطالبة</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <style>
    :root{--primary:#0B4C7A}
    body{font-family:"Tajawal",system-ui,-apple-system,Segoe UI,Roboto; background:#f7f9fb; color:#222; margin:0}
    .wrap{max-width:560px;margin:80px auto;padding:24px;background:#fff;border:1px solid #e5e7eb;border-radius:14px;box-shadow:0 6px 18px rgba(16,24,40,.06)}
    h1{margin:0 0 6px 0;font-size:22px;color:var(--primary)}
    .sub{margin:0 0 22px;color:#666}
    label{display:block;margin-bottom:8px;font-weight:600}
    input{width:100%;padding:12px 14px;border:1px solid #cbd5e1;border-radius:10px;font-size:16px}
    .row{display:flex;gap:10px;margin-top:14px}
    button{flex:1;padding:12px 16px;border:0;border-radius:10px;font-size:16px;cursor:pointer}
    .primary{background:var(--primary);color:#fff}
    .primary:hover{opacity:.92}
    .muted{background:#eef2f7;color:#111}
    .msg{margin-top:14px;font-weight:600}
    .ok{color:#127a3a}.err{color:#b42318}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>إعادة تفعيل رمز الطالبة</h1>
    <p class="sub">اكتب رمز الدخول (مثل RUK-006) لإعادة تفعيله لمدة 30 يومًا.</p>

    <label for="tokenInput">رمز الدخول</label>
    <input id="tokenInput" type="text" placeholder="RUK-006" />

    <div class="row">
      <button class="primary" onclick="resetToken()">إعادة التفعيل</button>
      <button class="muted" onclick="testClaim()">اختبار الدخول (SQL RPC)</button>
    </div>

    <p id="status" class="msg"></p>
  </div>

  <script>
    const SUPABASE_URL = "https://fjvbhlvwdbgyoooeqhhk.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZqdmJobHZ3ZGJneW9vb2VxaGhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE3NDExMzQsImV4cCI6MjA3NzMxNzEzNH0.vtoTj2to6RWGVXj3VbWTzxKkJcKRUKu9VgoeD792tQE";

    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

    function setMsg(text, ok=false){
      const el = document.getElementById('status');
      el.textContent = text;
      el.className = 'msg ' + (ok ? 'ok' : 'err');
    }

    async function resetToken(){
      const token = document.getElementById('tokenInput').value.trim();
      if(!token){ setMsg('الرجاء إدخال الرمز أولًا.'); return; }
      const { error } = await supa.rpc('reset_student_token', { p_token: token });
      if(error){ console.error(error); setMsg('حدث خطأ أثناء إعادة التفعيل.'); }
      else{ setMsg(`تم إعادة تفعيل الرمز ${token} بنجاح ✅`, true); }
    }

    // زر اختباري: يستدعي claim_student_token للتحقق أن الرمز يعمل مرة واحدة فقط
    async function testClaim(){
      const token = document.getElementById('tokenInput').value.trim();
      if(!token){ setMsg('أدخل الرمز ثم اضغط اختبار.'); return; }
      const { data, error } = await supa.rpc('claim_student_token', { p_token: token });
      if(error){ console.error(error); setMsg('الرمز غير صالح/منتهي أو مستخدم.'); return; }
      if(!data || data.length===0){ setMsg('الرمز مستخدم مسبقًا أو غير صالح.'); return; }
      const s = data[0];
      setMsg(`نجح الدخول: ${s.student_name} - ${s.class_name} ✅`, true);
    }
  </script>
</body>
</html>
